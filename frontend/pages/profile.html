<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - TravelEase</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>✈️</text></svg>">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="../css/styles.css" rel="stylesheet">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">
                <i class="fas fa-globe-americas me-2"></i>
                TravelEase
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="../index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="flights.html">Flights</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="trains.html">Trains</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="hotels.html">Hotels</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="contact.html">Contact</a>
                    </li>
                </ul>
                <div id="authButtons" class="d-flex">
                    <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#loginModal">Login</button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#registerModal">Register</button>
                </div>
                <div id="userDropdown" class="dropdown d-none">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-user-circle me-1"></i>
                        <span id="userName">User</span>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userMenuButton">
                        <li><a class="dropdown-item" href="profile.html"><i class="fas fa-user me-2"></i>My Profile</a></li>
                        <li><a class="dropdown-item" href="bookings.html"><i class="fas fa-list me-2"></i>My Bookings</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Alert Container -->
    <div id="mainAlert" class="container mt-3"></div>

    <!-- Page Header -->
    <section class="bg-primary text-white py-4">
        <div class="container">
            <h1><i class="fas fa-user me-2"></i>My Profile</h1>
            <p class="lead mb-0">Manage your account information and preferences</p>
        </div>
    </section>

    <!-- Profile Content -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0"><i class="fas fa-info-circle me-2"></i>User Information</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="fw-bold text-muted">Name:</label>
                                    <p class="mb-2" id="profileUsername">Loading...</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="fw-bold text-muted">Email:</label>
                                    <p class="mb-2" id="profileEmail">Loading...</p>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="fw-bold text-muted">Phone:</label>
                                    <p class="mb-2" id="profilePhone">Not provided</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-item">
                                    <label class="fw-bold text-muted">Member Since:</label>
                                    <p class="mb-2" id="profileJoinDate">Loading...</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-end">
                            <button class="btn btn-primary" id="editProfileBtn">
                                <i class="fas fa-edit me-1"></i>Edit Profile
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="editProfileModalLabel">
                        <i class="fas fa-user-edit me-2"></i>Edit Profile
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="editName" class="form-label">
                                <i class="fas fa-user me-1"></i>Full Name
                            </label>
                            <input type="text" class="form-control" id="editName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPhone" class="form-label">
                                <i class="fas fa-phone me-1"></i>Phone Number
                            </label>
                            <input type="tel" class="form-control" id="editPhone" placeholder="Enter your phone number">
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white">
        <div class="container py-5">
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">
                    <h5>TravelEase</h5>
                    <p>Your one-stop solution for all your travel booking needs. Find the best deals on flights, trains, and hotels.</p>
                    <div class="d-flex">
                        <a href="#" class="me-3"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="me-3"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="me-3"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="../index.html">Home</a></li>
                        <li><a href="flights.html">Flights</a></li>
                        <li><a href="trains.html">Trains</a></li>
                        <li><a href="hotels.html">Hotels</a></li>
                        <li><a href="about.html">About Us</a></li>
                        <li><a href="contact.html">Contact Us</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6 mb-4 mb-lg-0">
                    <h5>Support</h5>
                    <ul class="list-unstyled">
                        <li><a href="faq.html">FAQs</a></li>
                        <li><a href="#">Help Center</a></li>
                        <li><a href="#">Terms of Service</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Refund Policy</a></li>
                    </ul>
                </div>
                <div class="col-lg-3 col-md-6">
                    <h5>Contact Us</h5>
                    <ul class="list-unstyled">
                        <li><i class="fas fa-map-marker-alt me-2"></i>123 Travel Street, City</li>
                        <li><i class="fas fa-phone me-2"></i>+1 (555) 123-4567</li>
                        <li><i class="fas fa-envelope me-2"></i>info@travelease.com</li>
                    </ul>
                </div>
            </div>
            <hr class="my-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <p class="mb-0">&copy; 2024 TravelEase. All rights reserved.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">Made with <i class="fas fa-heart text-danger"></i> for travelers</p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Login Modal -->
    <div class="modal fade auth-modal" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="loginModalLabel">Login to Your Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="loginAlert"></div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="loginEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="loginEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="loginPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="loginPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe">
                            <label class="form-check-label" for="rememberMe">Remember me</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Login</button>
                    </form>
                    <div class="text-center mt-3">
                        <p>Don't have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">Register now</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Modal -->
    <div class="modal fade auth-modal" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="registerModalLabel">Create an Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="registerAlert"></div>
                    <form id="registerForm">
                        <div class="mb-3">
                            <label for="registerName" class="form-label">Full Name</label>
                            <input type="text" class="form-control" id="registerName" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerEmail" class="form-label">Email address</label>
                            <input type="email" class="form-control" id="registerEmail" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPhone" class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="registerPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="registerPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="registerPassword" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="agreeTerms" required>
                            <label class="form-check-label" for="agreeTerms">I agree to the <a href="#" data-terms-modal>Terms and Conditions</a></label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Register</button>
                    </form>
                    <div class="text-center mt-3">
                        <p>Already have an account? <a href="#" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        // API_BASE_URL is already defined in main.js and available globally via window.API_BASE_URL
        // We'll use window.API_BASE_URL directly in this script

        // Populate profile data from stored user object
        document.addEventListener("DOMContentLoaded", () => {
            const userJson = localStorage.getItem('user');
            const token = localStorage.getItem('token');
            
            if (!userJson || !token) {
                // Not logged in -> redirect to home page
                showAlert('mainAlert', 'Please log in to view your profile.', 'warning');
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                return;
            }

            try {
                const user = JSON.parse(userJson);
                console.log('User from localStorage:', user);
                
                // Optimistically render from localStorage first
                document.getElementById('profileUsername').textContent = user.name || 'User';
                document.getElementById('profileEmail').textContent = user.email || 'No email provided';
                document.getElementById('profilePhone').textContent = user.phone || 'Not provided';
                document.getElementById('profileJoinDate').textContent = user.createdAt
                  ? new Date(user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
                  : 'Not available';

                // Update navbar dropdown display if present
                const usernameDisplay = document.getElementById('userName');
                if (usernameDisplay) {
                    usernameDisplay.textContent = user.name || 'User';
                }
                
                console.log('Initial profile render complete from localStorage');

                // Refresh from API to ensure latest data and createdAt
                fetch(`${window.API_BASE_URL}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                })
                  .then(res => {
                      console.log('Profile API response status:', res.status);
                      if (!res.ok) {
                          return res.json().then(err => {
                              throw new Error(err?.error?.message || `HTTP ${res.status}`);
                          });
                      }
                      return res.json();
                  })
                  .then(data => {
                      console.log('Profile data received:', data);
                      if (!data || !data.user) {
                          console.error('No user data in response');
                          return;
                      }
                      // Update localStorage with fresh data
                      localStorage.setItem('user', JSON.stringify(data.user));
                      
                      // Update all profile fields
                      document.getElementById('profileUsername').textContent = data.user.name || 'User';
                      document.getElementById('profileEmail').textContent = data.user.email || 'No email provided';
                      document.getElementById('profilePhone').textContent = data.user.phone || 'Not provided';
                      document.getElementById('profileJoinDate').textContent = data.user.createdAt
                        ? new Date(data.user.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
                        : 'Not available';
                      
                      // Update navbar display
                      const usernameDisplay2 = document.getElementById('userName');
                      if (usernameDisplay2) usernameDisplay2.textContent = data.user.name || 'User';
                      
                      console.log('Profile updated successfully');
                  })
                  .catch((error) => {
                      console.error('Profile refresh error:', error);
                      // If API fails but we have localStorage data, keep showing it
                      // Only redirect on 401 (unauthorized)
                      if (error.message && error.message.includes('401')) {
                          showAlert('mainAlert', 'Session expired. Please log in again.', 'warning');
                          setTimeout(() => { window.location.href = '../index.html'; }, 1500);
                      } else {
                          // Show error but keep displaying cached data
                          console.warn('Using cached profile data due to API error');
                      }
                  });
            } catch (err) {
                console.error('Error parsing user from localStorage', err);
                showAlert('mainAlert', 'Error loading profile data. Please try logging in again.', 'danger');
            }

            // Setup edit profile functionality
            setupEditProfile();
        });

        // Setup edit profile modal handling
        function setupEditProfile() {
            const editBtn = document.getElementById('editProfileBtn');
            const editModalEl = document.getElementById('editProfileModal');
            const editForm = document.getElementById('editProfileForm');

            if (editBtn && editModalEl) {
                editBtn.addEventListener('click', () => {
                    const userJson = localStorage.getItem('user');
                    if (!userJson) return;
                    
                    try {
                        const user = JSON.parse(userJson);
                        document.getElementById('editName').value = user.name || '';
                        document.getElementById('editPhone').value = user.phone || '';
                        const modal = new bootstrap.Modal(editModalEl);
                        modal.show();
                    } catch (err) {
                        console.error('Error loading user data for edit:', err);
                        showAlert('mainAlert', 'Error loading profile data for editing.', 'danger');
                    }
                });
            }

            if (editForm) {
                editForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const name = document.getElementById('editName').value.trim();
                    const phone = document.getElementById('editPhone').value.trim();
                    const token = localStorage.getItem('token');
                    
                    if (!token) {
                        showAlert('mainAlert', 'You must be logged in to edit your profile.', 'warning');
                        return;
                    }

                    if (!name) {
                        showAlert('mainAlert', 'Name is required.', 'warning');
                        return;
                    }

                    try {
                        // Show loading state
                        const submitBtn = editForm.querySelector('button[type="submit"]');
                        const originalText = submitBtn.textContent;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Saving...';

                        const res = await fetch(`${window.API_BASE_URL}/users/profile`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({ name, phone })
                        });

                        const data = await res.json();

                        if (!res.ok) {
                            throw new Error(data.error?.message || 'Failed to update profile');
                        }

                        // Update local storage and UI
                        localStorage.setItem('user', JSON.stringify(data.user));
                        
                        // Update profile display
                        document.getElementById('profileUsername').textContent = data.user.name || 'User';
                        document.getElementById('profilePhone').textContent = data.user.phone || 'Not provided';
                        
                        // Update navbar display
                        const usernameDisplay = document.getElementById('userName');
                        if (usernameDisplay) {
                            usernameDisplay.textContent = data.user.name || 'User';
                        }

                        // Close modal and show success message
                        const modal = bootstrap.Modal.getInstance(editModalEl);
                        if (modal) modal.hide();
                        
                        showAlert('mainAlert', 'Profile updated successfully!', 'success');
                        
                        // Reset button state
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                        
                    } catch (err) {
                        console.error('Error updating profile:', err);
                        showAlert('mainAlert', err.message || 'An error occurred while updating profile.', 'danger');
                        
                        // Reset button state
                        const submitBtn = editForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Save Changes';
                    }
                });
            }
        }

        // Helper function to show alerts
        function showAlert(containerId, message, type) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    const alert = container.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        }
    </script>
</body>
</html>
